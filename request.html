<!DOCTYPE html>
<html>
<head>
	<title>Request & IndexedDB Testing</title>
</head>
<style type="text/css">
	th {
		padding: 0px 25px;
	}
	td {
		vertical-align: top !important;
		padding: 0px 25px;
	}
	tr:nth-of-type(even){
		background-color: lightgray;
	}
</style>
<script type="text/javascript">
	async function apiCall(){
		const indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB,
			  response = await fetch("http://localhost:8080/data/4"),
			  res = await response.json(),
			  req = indexedDB.open("JSON");

		req.onerror = function(e){
			console.log("DB Error");
			console.log(e);
		}

		req.onupgradeneeded = function(e){
			const db = e.target.result;

			db.createObjectStore("terrainTiles", {
				autoIncrement: true
			})
		}

		req.onsuccess = function(e){
			console.log("req.onsuccess");
			const db = e.target.result,
				  t = db.transaction(['terrainTiles'], 'readwrite'),
				  store = t.objectStore('terrainTiles');
			let   n = 0;

			Object.keys(res).forEach(function(key){
				const storeReq = store.put(res[key], key),
					  value = res[key];

				let subgridItems = "";

				for (var i = 0; i < value.subgrids.length; i++) {
					subgridItems += `<li>${JSON.stringify(value.subgrids[0][i])}</li>`;
				}

				document.querySelector("tbody").innerHTML += `<td>${n}</td><td>${key}</td><td>${value.average_elevation}</td><td>${subgridItems}</td><td>${value.x_pos}</td><td>${value.z_pos}</td>`;

				storeReq.onsucess = function(e){
					console.log("storeReq.onsuccess");
				}

				storeReq.onerror = function(e){
					console.log("storeReq.onerror");
					console.log(e);
				}

				n++;
			})
		}
	}
</script>
<body>
	<h1>Indexed DB <button onClick="apiCall()">Make API Call</button></h1>
	<table>
		<thead>
			<th>Index</th>
			<th>Key</th>
			<th>Avg. Elevation</th>
			<th>Subgrids</th>
			<th>X Pos</th>
			<th>Z Pos</th>
		</thead>
		<tbody></tbody>
	</table>
</body>
</html>